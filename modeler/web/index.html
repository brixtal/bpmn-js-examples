<html>
<head>
  <title>bpmn-js modeler demo</title>

  <link rel="stylesheet" href="css/diagram-js.css" />
  <link rel="stylesheet" href="vendor/bpmn-font/css/bpmn-embedded.css" />
  <link rel="stylesheet" href="css/app.css" />
  <link rel="stylesheet" href="css/bpmnt.css" />
  <link rel="stylesheet" href="css/jquery.contextMenu.css" />
  
  
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
 <script src="./jquery.contextMenu.js"></script>
 <script src="./bpmnt.js"></script>
    
</head>
<body>
  <a href='#' title="Close model" onclick="closeModel()"><img src='./img/if_Close_1891023.png' width="20" height="20" id='closeModel' class='closeModel'/></a>
  <div class="content" id="js-drop-zone">

  <!--  <div class="message intro">
      <div class="note">
		Drop BPMN diagram from your desktop or <a id="js-create-diagram" href>create a new diagram</a> to get started.
      </div>
    </div> -->

    <center id='loading' class='centered'>Loading...</center>

    <div class="message error">
      <div class="note">
        <p>Ooops, we could not display the BPMN 2.0 diagram.</p>

        <div class="details">
          <span>cause of the problem</span>
          <pre></pre>
        </div>
      </div>
    </div>

    <div class="canvas" id="js-canvas"></div>
  </div>
  <input type="button" value="Convert to BPMN File" class='download_bpmn button -regular ' onclick='download()'>
  <input type="button" value="Download BPMNt File" class='download_bpmnt button -regular ' onclick='downloadBPMNt()'>

  <ul class="buttons">
    <li>
      download
    </li>
    <li>
      <a id="js-download-diagram" href title="download BPMN diagram">
        BPMN diagram
      </a>
    </li>
    <li>
      <a id="js-download-svg" href title="download as SVG image">
        SVG image
      </a>
    </li>
  </ul>
</body>
  <script>

var parser = new DOMParser();

var bpmnXml = parser.parseFromString(decodeURIComponent(sessionStorage.bpmn), 'text/xml');

function createSequenceFlow() {
  var sequenceFlowElement = 'SequenceFlow_' + Math.random().toString().replace('0.','');
  return sequenceFlowElement;
}

function closeModel(){
  sessionStorage.removeItem('bpmn');
  sessionStorage.removeItem('bpmnt');
  sessionStorage.removeItem('tailoring');
  location.reload();
}

$(function() {
        $.contextMenu({
            selector: '.djs-element', 
            callback: function(key, options) {
                var m = key + " on " + $(this).attr("data-element-id");
        var action, selectedElement;
        window.console && console.log(m); 
        selectedElement = $(this).attr("data-element-id");
        if(key == "insert-s"){
          

           if (isValidElement(selectedElement, key)){            
             
             var bpmnString = operationInsertSerial (selectedElement, bpmnXml);

             sessionStorage.bpmn = encodeURIComponent(bpmnString);
            
             location.reload();
           }
           else {
            alert('É inválido');
           }

        }

        if(key == 'rename') {
          
          var name = prompt("Please enter the new name:", ""); 
          if(name == null) name = ''; 

          sessionStorage.bpmn =  encodeURIComponent(operationRename(selectedElement, name, bpmnXml));

          location.reload();
        }

        
        if(key == "merge"){
                    
          var selectedHtmlElement = $('#js-canvas')[0].getElementsByClassName('selected');          

          var bpmnString = operationMerge(selectedHtmlElement, bpmnXml);

          sessionStorage.bpmn = encodeURIComponent(bpmnString);

          location.reload();

        }
        if(key == "delete") {
          if (isValidElement(selectedElement, key)){ 
            

            var bpmnString = operationDelete(selectedElement, bpmnXml);

            sessionStorage.bpmn = encodeURIComponent(bpmnString);

            location.reload();
          }
          else {
            alert("You can't delete " + selectedElement);
          }
        }
        },
          items: {
              "delete": {name: "Delete"},
              "replace": {name: "Replace", disabled: true},
              "move": {name: "Move", disabled: true},
              "paralellize": {name: "Paralellize", disabled: true},
              "encapsulate": {name: "Encapsulate", disabled: true},
              "split": {name: "Split", disabled: true},
              "merge": {name: "Merge"},
              "rename": {name: "Rename"},
              "fold1": {
                  "name":"Exception",
                  "items": {
                    "exception-h": {name: "Handler", disabled: true},
                    "exception-f": {name: "Flow", disabled: true},
                  }, disabled: true
              },
              "fold2": {
                "name":"Insert",
                "items": {
                  "insert-s": {name: "Serial"},
                  "insert-c": {name: "Conditional", disabled: true},
                  "insert-e": {name: "Event-based", disabled: true}
              }
            }   
          }
        });

        $('.context-menu-one').on('click', function(e){
            console.log('clicked', this);
        })    
    });

    

</script>

  <script src="index.js" onload="$('#loading').hide();"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.js" type="text/javascript"></script>

    <script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.ui.position.min.js" type="text/javascript"></script>

    <script src="https://swisnl.github.io/jQuery-contextMenu/js/main.js" type="text/javascript"></script>
</html>
